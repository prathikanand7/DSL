package gameoflife.dsl.validation

import org.eclipse.xtext.validation.Check
import gameoflife.dsl.gameOfLifeDSL.GameOfLifeDSLPackage.Literals
import gameoflife.dsl.gameOfLifeDSL.Cell
import gameoflife.dsl.gameOfLifeDSL.NeighborCondition
import gameoflife.dsl.gameOfLifeDSL.Range

class GameOfLifeDSLValidator extends AbstractGameOfLifeDSLValidator {
    
    public static val INVALID_GRID_COORDINATES = "invalidGridCoordinates"
    public static val INVALID_NEIGHBOR_COUNT = "invalidNeighborCount"
    public static val DUPLICATE_CELL = "duplicateCell"
    
    @Check
    def checkCellCoordinates(Cell cell) {
        val x = getIntValue(cell.x)
        val y = getIntValue(cell.y)
        
        if (x < 0 || x >= 100) {
            error("X coordinate must be between 0 and 99", 
                  Literals.CELL__X,
                  INVALID_GRID_COORDINATES)
        }
        
        if (y < 0 || y >= 100) {
            error("Y coordinate must be between 0 and 99", 
                  Literals.CELL__Y,
                  INVALID_GRID_COORDINATES)
        }
    }
    
    @Check
    def checkNeighborCondition(NeighborCondition condition) {
        if (condition.range !== null) {
            val min = getIntValue(condition.range.min)
            val max = getIntValue(condition.range.max)
            
            if (min < 0 || max > 8) {
                error("Neighbor count range must be between 0 and 8", 
                      null,
                      INVALID_NEIGHBOR_COUNT)
            }
            if (min > max) {
                error("Range minimum cannot be greater than maximum", 
                      null,
                      INVALID_NEIGHBOR_COUNT)
            }
        } else {
            val count = getIntValue(condition.count)
            if (count < 0 || count > 8) {
                error("Neighbor count must be between 0 and 8", 
                      Literals.NEIGHBOR_CONDITION__COUNT,
                      INVALID_NEIGHBOR_COUNT)
            }
        }
    }
    
    @Check
    def checkDuplicateCells(gameoflife.dsl.gameOfLifeDSL.Grid grid) {
        val seenCells = newHashMap()
        
        for (cell : grid.liveCells) {
            val key = cell.x + "," + cell.y
            if (seenCells.containsKey(key)) {
                error("Duplicate cell at (" + cell.x + ", " + cell.y + ")", 
                      null,
                      DUPLICATE_CELL)
            } else {
                seenCells.put(key, cell)
            }
        }
    }
    
    // Helper method to convert string to int safely
    private def int getIntValue(String str) {
        try {
            return Integer.parseInt(str)
        } catch (NumberFormatException e) {
            return -1 // Return invalid value that will trigger validation
        }
    }
}